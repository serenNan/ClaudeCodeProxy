name: ðŸ” Continuous Integration

on:
  push:
    branches: [ main, develop ]
    paths-ignore:
      - '**.md'
      - '.gitignore'
      - 'LICENSE'
  pull_request:
    branches: [ main, develop ]
    paths-ignore:
      - '**.md'
      - '.gitignore'
      - 'LICENSE'

env:
  DOTNET_VERSION: '9.0.x'
  NODE_VERSION: '20.x'

jobs:
  # ============================================================================
  # Frontend CI
  # ============================================================================
  frontend-ci:
    name: ðŸŽ¨ Frontend CI
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout Code
      uses: actions/checkout@v4
      
    - name: ðŸ“¦ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: 'web/package-lock.json'
        
    - name: ðŸ“‹ Install Dependencies
      working-directory: ./web
      run: npm ci --prefer-offline --no-audit
      
    - name: ðŸ” Lint Code
      working-directory: ./web
      run: |
        npm run lint || echo "âš ï¸ Linting issues found"
        npm run type-check || echo "âš ï¸ Type checking issues found"
      
    - name: ðŸ§ª Run Tests
      working-directory: ./web
      run: npm run test:ci || echo "âš ï¸ Some tests failed"
      
    - name: ðŸ”§ Build Project
      working-directory: ./web
      run: npm run build
      
    - name: ðŸ“Š Bundle Analysis
      working-directory: ./web
      run: |
        if [ -f "dist/index.html" ]; then
          echo "âœ… Build successful"
          echo "ðŸ“¦ Build size analysis:" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          du -sh dist/* | sort -hr >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ Build failed - index.html not found"
          exit 1
        fi

  # ============================================================================
  # Backend CI
  # ============================================================================
  backend-ci:
    name: ðŸ”§ Backend CI
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout Code
      uses: actions/checkout@v4
      
    - name: ðŸ“¦ Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
        
    - name: ðŸ” Restore Dependencies
      run: dotnet restore
      
    - name: ðŸ”§ Build Project
      run: dotnet build --no-restore --configuration Release
      
    - name: ðŸ§ª Run Tests
      run: |
        dotnet test --no-build --configuration Release --verbosity normal \
          --collect:"XPlat Code Coverage" \
          --results-directory ./coverage
      
    - name: ðŸ“Š Code Coverage Report
      uses: codecov/codecov-action@v3
      with:
        directory: ./coverage
        flags: backend
        name: backend-coverage
      continue-on-error: true
      
    - name: ðŸ” Security Scan
      run: |
        dotnet list package --vulnerable --include-transitive || echo "âš ï¸ Vulnerable packages found"
        
    - name: ðŸ“‹ Build Summary
      run: |
        echo "## ðŸ”§ Backend Build Summary" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Build completed successfully" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ§ª Tests executed" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ” Security scan completed" >> $GITHUB_STEP_SUMMARY

  # ============================================================================
  # Integration Tests
  # ============================================================================
  integration-tests:
    name: ðŸ§ª Integration Tests
    runs-on: ubuntu-latest
    needs: [frontend-ci, backend-ci]
    
    services:
      sqlite:
        image: alpine:latest
        options: --health-cmd "echo 'healthy'" --health-interval 10s --health-timeout 5s --health-retries 5
    
    steps:
    - name: ðŸ“¥ Checkout Code
      uses: actions/checkout@v4
      
    - name: ðŸ“¦ Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
        
    - name: ðŸ“¦ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: 'web/package-lock.json'
        
    - name: ðŸ”§ Build Backend
      run: |
        dotnet restore
        dotnet build --no-restore --configuration Release
        
    - name: ðŸ”§ Build Frontend
      working-directory: ./web
      run: |
        npm ci --prefer-offline --no-audit
        npm run build
        
    - name: ðŸš€ Start Application
      run: |
        # Start backend in background
        cd src/ClaudeCodeProxy.Host
        dotnet run --configuration Release &
        BACKEND_PID=$!
        echo "BACKEND_PID=$BACKEND_PID" >> $GITHUB_ENV
        
        # Wait for backend to start
        echo "â³ Waiting for backend to start..."
        for i in {1..30}; do
          if curl -s http://localhost:5000/health > /dev/null 2>&1; then
            echo "âœ… Backend started successfully"
            break
          fi
          sleep 2
          if [ $i -eq 30 ]; then
            echo "âŒ Backend failed to start"
            exit 1
          fi
        done
      
    - name: ðŸ§ª Run Integration Tests
      run: |
        echo "ðŸ§ª Running basic API tests..."
        
        # Test health endpoint
        response=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:5000/health)
        if [ "$response" != "200" ]; then
          echo "âŒ Health check failed (HTTP $response)"
          exit 1
        fi
        echo "âœ… Health check passed"
        
        # Test API documentation endpoint
        response=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:5000/scalar/v1)
        if [ "$response" != "200" ]; then
          echo "âŒ API docs check failed (HTTP $response)"
          exit 1
        fi
        echo "âœ… API documentation accessible"
        
        echo "âœ… All integration tests passed"
      
    - name: ðŸ§¹ Cleanup
      if: always()
      run: |
        if [ ! -z "$BACKEND_PID" ]; then
          kill $BACKEND_PID || true
        fi

  # ============================================================================
  # Quality Gates
  # ============================================================================
  quality-gate:
    name: ðŸš¦ Quality Gate
    runs-on: ubuntu-latest
    needs: [frontend-ci, backend-ci, integration-tests]
    if: always()
    
    steps:
    - name: ðŸ“Š Check Results
      run: |
        echo "## ðŸš¦ Quality Gate Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Check job results
        frontend_result="${{ needs.frontend-ci.result }}"
        backend_result="${{ needs.backend-ci.result }}"
        integration_result="${{ needs.integration-tests.result }}"
        
        echo "| Component | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|-----------|--------|" >> $GITHUB_STEP_SUMMARY
        
        if [ "$frontend_result" == "success" ]; then
          echo "| ðŸŽ¨ Frontend | âœ… Passed |" >> $GITHUB_STEP_SUMMARY
        else
          echo "| ðŸŽ¨ Frontend | âŒ Failed |" >> $GITHUB_STEP_SUMMARY
        fi
        
        if [ "$backend_result" == "success" ]; then
          echo "| ðŸ”§ Backend | âœ… Passed |" >> $GITHUB_STEP_SUMMARY
        else
          echo "| ðŸ”§ Backend | âŒ Failed |" >> $GITHUB_STEP_SUMMARY
        fi
        
        if [ "$integration_result" == "success" ]; then
          echo "| ðŸ§ª Integration | âœ… Passed |" >> $GITHUB_STEP_SUMMARY
        else
          echo "| ðŸ§ª Integration | âŒ Failed |" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Overall result
        if [ "$frontend_result" == "success" ] && [ "$backend_result" == "success" ] && [ "$integration_result" == "success" ]; then
          echo "ðŸŽ‰ **Overall Result: PASSED**" >> $GITHUB_STEP_SUMMARY
          echo "All quality gates have been successfully passed!"
        else
          echo "âŒ **Overall Result: FAILED**" >> $GITHUB_STEP_SUMMARY
          echo "One or more quality gates have failed. Please review the issues above."
          exit 1
        fi